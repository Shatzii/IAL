
version: '3.8'

services:
  # Edge Proxy & SSL
  traefik:
    image: traefik:v2.10
    container_name: ial-traefik
    restart: always
    command:
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.myresolver.acme.email=ops@ial-football.com"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./letsencrypt:/letsencrypt"

  # Intake API (FastAPI)
  intake-api:
    build: 
      context: .
      dockerfile: ./infra/Dockerfile.api
    container_name: ial-api
    restart: always
    environment:
      - API_KEY=${IAL_API_KEY:-IAL_SECRET_HANDSHAKE_2024}
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-pass}@postgres:5432/intake
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.ial-football.com`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=myresolver"
    depends_on:
      postgres:
        condition: service_healthy

  # Object Storage for Documents
  minio:
    image: minio/minio
    container_name: ial-storage
    restart: always
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: ${MINIO_PASS:-ial_storage_pass}
    command: server /data --console-address ":9001"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.storage.rule=Host(`s3.ial-football.com`)"
      - "traefik.http.routers.storage.entrypoints=websecure"
      - "traefik.http.routers.storage.tls.certresolver=myresolver"
    volumes:
      - minio_data:/data

  postgres:
    image: postgres:15-alpine
    container_name: ial-postgres
    restart: always
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-pass}
      POSTGRES_DB: intake
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
  minio_data:
